---
templates:
  - name: Template Module Windows services by Zabbix agent
    description: Template Services OS Windows
    _zbx_ver: "4.4"
    _classes:
      - MODULE
      - ZABBIX_ACTIVE
    _documentation:
      overview: Special version of services template that is required for Windows OS.
      # _issues:
      #   - description: ""
    macros:
      - macro: "{$SERVICE.NAME.MATCHES}"
        value: ^.*$
        _description: "This macro is used in Service discovery. Can be overridden on the host or linked template level."
      - macro: "{$SERVICE.NAME.NOT_MATCHES}"
        value: ^RemoteRegistry|MMCSS|gupdate|SysmonLog|clr_optimization_v2.0.50727_32|clr_optimization_v4.0.30319_32|sppsvc|gpsvc|Pml Driver HPZ12|Net Driver HPZ12|MapsBroker|IntelAudioService|Intel(R) TPM Provisioning Service$
        _description: "This macro is used in Service discovery. Can be overridden on the host or linked template level."
      - macro: "{$SERVICE.STARTUPNAME.MATCHES}"
        value: ^automatic|automatic delayed$
        _description: "This macro is used in Service discovery. Can be overridden on the host or linked template level."
      - macro: "{$SERVICE.STARTUPNAME.NOT_MATCHES}"
        value: ^manual|disabled$
        _description: "This macro is used in Service discovery. Can be overridden on the host or linked template level."
    discovery_rules:
      - name: Windows services discovery
        key: service.discovery
        type: "ZABBIX_PASSIVE"
        delay: 1h
        description: |
          Discovery of Windows services of different types as defined in template's macros.
        filter:
          evaltype: AND
          conditions:
            - macro: "{#SERVICE.NAME}"
              value: "{$SERVICE.NAME.MATCHES}"
              operator: "MATCHES_REGEX"
              formulaid: A
            - macro: "{#SERVICE.NAME}"
              value: "{$SERVICE.NAME.NOT_MATCHES}"
              operator: NOT_MATCHES_REGEX
              formulaid: B
            - macro: "{#SERVICE.STARTUPNAME}"
              value: "{$SERVICE.STARTUPNAME.MATCHES}"
              operator: "MATCHES_REGEX"
              formulaid: C
            - macro: "{#SERVICE.STARTUPNAME}"
              value: "{$SERVICE.STARTUPNAME.NOT_MATCHES}"
              operator: NOT_MATCHES_REGEX
              formulaid: D
        items:
          - _id: service.state
            _group: Services
            _resource: "Service"
            type: "ZABBIX_PASSIVE"
            name: State of "{#SERVICE.NAME}" ({#SERVICE.DISPLAYNAME})
            key: service.info["{#SERVICE.NAME}",state]
            value_type: UNSIGNED
            delay: 1m
            history: 7d
            trends: 365d
            value_map: Windows service state
            description: "Information about a state of a service."
            triggers:
              - _id: trigger.service.average
                name: '"{#SERVICE.NAME}" ({#SERVICE.DISPLAYNAME}) is not running (startup type {#SERVICE.STARTUPNAME})'
                priority: AVERAGE
                expression: "{TEMPLATE_NAME:METRIC.min(#3)}<>0"
                description: |
                  The service has a state other than "Running" for the last three times.
value_maps:
  - name: Windows service state
    mappings:
      - value: "0"
        newvalue: Running
      - value: "1"
        newvalue: Paused
      - value: "2"
        newvalue: Start pending
      - value: "3"
        newvalue: Pause pending
      - value: "4"
        newvalue: Continue pending
      - value: "5"
        newvalue: Stop pending
      - value: "6"
        newvalue: Stopped
      - value: "7"
        newvalue: Unknown
      - value: "255"
        newvalue: No such service
